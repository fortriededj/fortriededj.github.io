<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
</head>

<body>
    <div id="main" style="width: 95%;height:90%;"></div>

</body>
<style>
    body {
        color: #c57000;
    }
</style>

<script>
    function initChart(option) {
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;
        option && myChart.setOption(option);
    }
</script>

<script>
    let url = 'DKF_Labs.json';

    let data = {}

    fetch(url)
        .then(res => res.json())
        .then(out => {
            const colors = ['#1c9126', '#5470C6', '#910000', '#c57000'];

            const events =
                [
                    {
                        'date': '2024-09-05',
                        'event': 'Transfusion'
                    },
                    {
                        'date': '2021-05-26',
                        'event': 'Cardiac Stents',
                        'offset': 3
                    },
                    {
                        'date': '2021-09-03',
                        'event': 'Swallow Study 1',
                        'offset': 1
                    },
                    {
                        'date': '2024-07-25',
                        'event': 'Swallow Study 2',
                        'offset': 1
                    },
                    {
                        'date': '2016-02-26',
                        'event': 'CT: Stone',
                        'offset': 1
                    },
                    {
                        'date': '2021-02-26',
                        'event': 'CT: Stone',
                        'offset': 2
                    },
                    {
                        'date': '2021-05-14',
                        'event': 'Creon',
                        'offset': 1
                    },
                    {
                        'date': '2019-12-16',
                        'event': 'Spider Bite'
                    },
                    {
                        'date': '2021-06-01',
                        'event': 'TAVR'
                    },
                    {
                        'date': '2021-06-02',
                        'event': 'Pacemaker',
                        'offset': 1
                    },
                    {
                        'date': '2021-06-02',
                        'event': 'Transfusion',
                        'offset': 2,
                    },
                    {
                        'date': '2002-12-05',
                        'event': 'Transplant'
                    },
                    {
                        'date': '2022-03-03',
                        'event': 'Heart Cath'
                    },
                    {
                        'date': '2022-12-15',
                        'event': 'Edema Hosp.',
                        'offset': 1
                    },
                    {
                        'date': '2021-07-23',
                        'event': 'TEE',
                    },
                    {
                        'date': '2021-04-29',
                        'event': 'ER: Pleural Eff.',
                        'offset': 1
                    },
                    {
                        'date': '2021-04-01',
                        'event': 'Pancreatic Stone'
                    },
                    {
                        'date': '2024-09-03',
                        'event': 'ER: Malnutrition'
                    },
                    {
                        'date': '2024-09-16',
                        'event': 'NJ Tube'
                    },
                    {
                        'date': '2016-02-26',
                        'event': 'Retirement'
                    }
                ]
            const manualValues = {
                "Patient Measurements": {
                    "Weight": {
                        '2024-09-20': 137,
                        '2024-09-19': 155.6
                    }
                }
            }
            var epochs;
            storeDates();
            console.log('Checkout this JSON! ', out);

            events.forEach(function (item) {
                interjectDate(item['date']);
            });

            for (const [category, value] of Object.entries(manualValues)) {
                for (const [key, data] of Object.entries(value)) {
                    for (const [date, value] of Object.entries(data)) {
                        addManualValue(category, key, date, value);
                    }
                }
            }

            var dataset = { 'source': [] };
            dataset['dimensions'] =

                console.log(dataset);

            option = {
                legend: {},
                grid: {
                    bottom: 100,
                },
                xAxis: [{
                    type: 'category',
                    axisLabel: {
                        rotate: 30
                    },
                    data: out['Dates'].map(function (item) {
                        // convert epoch to date
                        return epochToDay(item);
                    })
                }]
                ,
                yAxis: [
                    {
                        type: 'value',
                        name: 'Weight',
                        min: 100,
                        max: 300,
                        position: 'right',
                        alignTicks: true,
                        axisLine: {
                            lineStyle: {
                                color: colors[1]
                            }
                        },
                        axisLabel: {
                            formatter: '{value} lbs'
                        },
                        interval: 50
                    }, {
                        type: 'value',
                        name: 'RBC',
                        min: 0,
                        max: 6,
                        position: 'left',
                        alignTicks: true,
                        axisLine: {
                            lineStyle: {
                                color: colors[2]
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        },
                        splitNumber: 5
                    }, {
                        type: 'value',
                        name: 'Creatinine',
                        min: 0,
                        max: 10,
                        offset: 80,
                        position: 'left',
                        alignTicks: true,
                        axisLine: {
                            lineStyle: {
                                color: colors[3]
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        },
                        splitNumber: 5
                    }
                ],
                tooltip: [{
                    order: 'valueDesc',
                    trigger: 'axis',
                    position: function (pt) {
                        return [pt[0], '10%'];
                    },
                }
                ],
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none',
                            offset: 100
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 30,
                        end: 100,
                        xAxisIndex: [0]
                    },
                    {
                        start: 90,  //Not sure why I need this but I do. 
                        end: 100
                    }
                ],
                series: [

                    {
                        type: 'line',
                        name: 'Weight',
                        color: colors[1],
                        data: out['Dates'].map(function (epoch) {
                            if (epoch in out['DATA']['Patient Measurements']['Weight']) {
                                return out['DATA']['Patient Measurements']['Weight'][epoch]['Value']
                            }
                            return '';
                        }),
                        connectNulls: true,
                        yAxisIndex: 0,
                        markPoint: {
                            data: [
                                { type: 'max', name: 'Max' },
                                { type: 'min', name: 'Min' },
                            ]
                        }
                    },

                    {
                        type: 'line',
                        name: 'RBC',
                        color: colors[2],
                        data: out['Dates'].map(function (item) {
                            if (item in out['DATA']['CBC']['RBC']) {
                                return out['DATA']['CBC']['RBC'][item]['Value']
                            }
                            return '';
                        }),
                        connectNulls: true,
                        yAxisIndex: 1
                    },

                    {
                        type: 'line',
                        name: 'Creatinine',
                        color: colors[3],
                        data: out['Dates'].map(function (item) {
                            if (item in out['DATA']['CMP']['Creatinine']) {
                                return out['DATA']['CMP']['Creatinine'][item]['Value']
                            }
                            return '';
                        }),
                        connectNulls: true,
                        yAxisIndex: 2,
                    },
                    {
                        type: 'scatter',
                        name: 'Events',

                        markPoint: {
                            label: {
                                formatter: function (param) {
                                    return param.name
                                }
                            },
                            data: events.map(function (item) {
                                return {
                                    name: item['event'],
                                    coord: [item['date'], 0],
                                    symbol: 'pin',
                                    symbolSize: [20, 30],
                                    label: {
                                        position: [0, -15],
                                        offset: [0, -item['offset'] * 15 || 0]
                                    }
                                }
                            })

                        },
                        symbol: 'pin',
                        yAxisIndex: 1
                    }

                ]
            };

            console.log(option);

            function interjectDate(date) {
                indexof = epochs.indexOf(date);
                if (indexof != -1) {
                    console.log("Date already exists", date);
                    return indexof;
                }
                console.log("Date does not exist", date);

                epoch = new Date(date).valueOf() / 1000
                out['Dates'].push(epoch)
                out['Dates'].sort(function (a, b) { return a - b });
                storeDates();
            }

            function addManualValue(category, key, date, value) {
                indexof = interjectDate(date);

                console.log("Index of", date, "is", indexof, out['Dates'][indexof]);
                return out['DATA'][category][key][out['Dates'][indexof]] = { 'Value': value }
            }

            function storeDates() {
                epochs = out['Dates'].map(function (item) {
                    return epochToDay(item);
                })

            }
            initChart(option);
        }
        )
        .catch(err => console.log(err));

    // console.log("Dataset:", dataset)

    function epochToDay(epoch) {
        var date = new Date(epoch * 1000);
        var iso = date.toISOString().match(/(\d{4}\-\d{2}\-\d{2})T(\d{2}:\d{2}:\d{2})/)

        return iso[1]
    }

</script>

</html>